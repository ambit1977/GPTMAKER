name: ã‚«ã‚¹ã‚¿ãƒ GPT CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: 3.9

jobs:
  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé™çš„è§£æ
  lint-prompts:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
      run: |
        # YAMLãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        find . -name "*.yaml" -o -name "*.yml" | xargs -I {} sh -c 'echo "Checking {}"; python -c "import yaml; yaml.safe_load(open(\"{}\"))"'
        
        # JSONãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯  
        find . -name "*.json" | xargs -I {} sh -c 'echo "Checking {}"; python -c "import json; json.load(open(\"{}\"))"'
        
        # Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯
        find . -name "*.md" | xargs -I {} echo "Markdown file: {}"

  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå˜ä½“ãƒ†ã‚¹ãƒˆ
  unit-test:
    runs-on: ubuntu-latest
    needs: lint-prompts
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        python -m pytest tests/unit/ -v --junitxml=test-results-unit.xml
        
    - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-results
        path: test-results-unit.xml

  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ“ãƒ«ãƒ‰
  build-prompts:
    runs-on: ubuntu-latest
    needs: unit-test
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
      run: |
        python scripts/build_prompts.py
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ç¢ºèª
      run: |
        ls -la build/
        echo "=== ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ==="
        cat build/main_prompt.txt
        echo "=== è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« ==="
        cat build/gpt_config.json
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      with:
        name: built-prompts
        path: build/

  # çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
  integration-test:
    runs-on: ubuntu-latest
    needs: build-prompts
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Seleniumä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Chromeã¨ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # ChromeDriverã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f3 | cut -d '.' -f1)
        wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}/chromedriver_linux64.zip"
        unzip /tmp/chromedriver.zip -d /tmp/
        sudo mv /tmp/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v3
      with:
        name: built-prompts
        path: build/
        
    - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      env:
        CHATGPT_EMAIL: ${{ secrets.CHATGPT_EMAIL }}
        CHATGPT_PASSWORD: ${{ secrets.CHATGPT_PASSWORD }}
      run: |
        python -m pytest tests/integration/ -v --junitxml=test-results-integration.xml
        
    - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: test-results-integration.xml

  # é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-dev:
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/develop'
    environment: development
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v3
      with:
        name: built-prompts
        path: build/
        
    - name: é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
      env:
        CHATGPT_EMAIL: ${{ secrets.CHATGPT_EMAIL }}
        CHATGPT_PASSWORD: ${{ secrets.CHATGPT_PASSWORD }}
      run: |
        pip install -r requirements.txt
        python scripts/chatgpt_deployer.py --config build/gpt_config.json --action update --name "MyGPT-Dev"

  # æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-prod:
    runs-on: ubuntu-latest
    needs: build-prompts
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - uses: actions/checkout@v3
    
    - name: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªå¾…æ©Ÿ
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.TOKEN }}
        approvers: ${{ secrets.APPROVERS }}
        minimum-approvals: 1
        issue-title: "æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èª"
        issue-body: |
          ## æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ç”³è«‹
          
          **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref }}
          **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
          **ä½œæˆè€…**: ${{ github.actor }}
          
          ### å¤‰æ›´å†…å®¹
          ${{ github.event.head_commit.message }}
          
          ### ãƒ‡ãƒ—ãƒ­ã‚¤å†…å®¹ç¢ºèª
          - [ ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã®ç¢ºèªå®Œäº†
          - [ ] ãƒ†ã‚¹ãƒˆçµæœã®ç¢ºèªå®Œäº†
          - [ ] å½±éŸ¿ç¯„å›²ã®ç¢ºèªå®Œäº†
          
          æ‰¿èªã™ã‚‹å ´åˆã¯ "approved" ã¨ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚
        
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v3
      with:
        name: built-prompts
        path: build/
        
    - name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
      env:
        CHATGPT_EMAIL: ${{ secrets.CHATGPT_EMAIL }}
        CHATGPT_PASSWORD: ${{ secrets.CHATGPT_PASSWORD }}
      run: |
        pip install -r requirements.txt
        python scripts/chatgpt_deployer.py --config build/gpt_config.json --action update --name "MyGPT-Prod"
        
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'ğŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'âŒ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  performance-test:
    runs-on: ubuntu-latest
    needs: deploy-prod
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      env:
        CHATGPT_EMAIL: ${{ secrets.CHATGPT_EMAIL }}
        CHATGPT_PASSWORD: ${{ secrets.CHATGPT_PASSWORD }}
      run: |
        pip install -r requirements.txt
        python tests/performance/performance_test.py
        
    - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      with:
        name: performance-test-results
        path: performance-results.json
